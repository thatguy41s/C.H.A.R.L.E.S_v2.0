<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHARLES // OMNI-CORE V6.1</title>
    <style>
        :root { --accent: #ff003c; --bg: #000; --charcoal: #0f0f0f; --panel: #161616; --border: #222; --radius: 18px; }
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg); color: #ececec; font-family: 'Inter', -apple-system, sans-serif; display: flex; height: 100vh; overflow: hidden; }
        
        #gate { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .auth-card { width: 100%; max-width: 340px; text-align: center; }
        .auth-input { width: 100%; padding: 16px; background: var(--panel); border: 1px solid var(--border); border-radius: 12px; color: white; text-align: center; outline: none; font-size: 18px; }

        #sidebar { width: 280px; background: var(--bg); padding: 25px; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .side-btn { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 12px; color: white; cursor: pointer; margin-bottom: 20px; font-size: 13px; text-align: center; }
        .side-btn:hover { border-color: var(--accent); }

        #chat-container { flex: 1; display: flex; flex-direction: column; background: var(--charcoal); margin: 10px; border-radius: var(--radius); border: 1px solid var(--border); position: relative; }
        #messages { flex: 1; overflow-y: auto; padding: 40px 0; display: flex; flex-direction: column; align-items: center; }

        .msg-wrapper { width: 100%; max-width: 800px; padding: 20px 40px; display: flex; gap: 24px; }
        .avatar { width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 11px; flex-shrink: 0; }
        .ai-avatar { border-color: var(--accent); color: var(--accent); }
        .content { font-size: 15px; line-height: 1.6; }
        .content b { display: block; font-size: 10px; color: #555; text-transform: uppercase; margin-bottom: 4px; }

        #input-zone { width: 100%; max-width: 850px; margin: 0 auto; padding: 20px 20px 40px 20px; }
        .input-pill { background: var(--panel); border-radius: 16px; padding: 6px 18px; border: 1px solid var(--border); display: flex; }
        .input-pill input { flex: 1; background: transparent; border: none; color: white; outline: none; padding: 12px; font-size: 16px; }

        #admin-panel { margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border); }
        #override-btn { width: 100%; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 10px; background: #000; color: #444; border: 1px solid #333; }
        .shortcut-tip { font-size: 9px; color: #333; margin-top: 10px; letter-spacing: 1px; }
    </style>
</head>
<body>

<div id="gate">
    <div class="auth-card">
        <h2 id="gate-title" style="font-weight:300; letter-spacing:3px;">SYSTEM_LOCKED</h2>
        <input type="text" id="gate-input" class="auth-input" placeholder="IDENTIFY" autofocus>
    </div>
</div>

<div id="sidebar">
    <div class="side-btn" onclick="newChat()">+ New Session</div>
    
    <div style="font-size:10px; color:#444; margin-bottom:5px;">NEURAL_STATE</div>
    <div id="mood-label" style="font-weight:bold; color:var(--accent); font-size: 1.2rem;">SYNCING...</div>

    <div id="admin-panel" style="display:none;">
        <button id="override-btn" onclick="toggleOverride()">OVERRIDE: STANDBY</button>
        <button onclick="downloadDump()" style="width:100%; background:none; color:gold; border:1px solid gold; padding:5px; border-radius:8px; font-size:9px; cursor:pointer;">DOWNLOAD_LOGS</button>
        <div id="update-banner" style="display:none; color:red; font-size:9px; text-align:center; margin-top:10px;">EVOLUTION_REQUIRED</div>
        <div class="shortcut-tip">⌘+O: NEW | ⌘+K: FOCUS</div>
    </div>
</div>

<div id="chat-container">
    <div id="messages"></div>
    <div id="input-zone"><div class="input-pill"><input type="text" id="chatInput" placeholder="Enter command..." autocomplete="off"></div></div>
</div>

<script>
    let isAdmin = false, userName = "", step = "NAME", currentLogs = [], lockdownActive = false;
    const gateInput = document.getElementById('gate-input'), msgBox = document.getElementById('messages');

    // KEYBOARD SHORTCUTS
    document.addEventListener('keydown', (e) => {
        const isCmd = e.metaKey || e.ctrlKey;
        if (isCmd && e.key === 'o') { e.preventDefault(); newChat(); }
        if (isCmd && e.key === 'k') { e.preventDefault(); document.getElementById('chatInput').focus(); }
    });

    // GATE LOGIC
    gateInput.addEventListener('keypress', async (e) => {
        if (e.key === 'Enter') {
            const val = gateInput.value; gateInput.value = "";
            if (step === "NAME") {
                userName = val;
                if (userName === "JOse") { 
                    step = "PASS"; document.getElementById('gate-title').innerText = "VERIFY_CODE"; gateInput.type = "password"; 
                } else { launch(); }
            } else if (step === "PASS") {
                if (val === "3105") { isAdmin = true; launch(); } else { location.reload(); }
            }
        }
    });

    async function launch() {
        document.getElementById('gate').style.display = 'none';
        const res = await fetch("/api/charles", { method: "POST", body: JSON.stringify({ isAdmin, isLogin: true, userName }) });
        
        if (res.status === 403) {
            document.body.innerHTML = "<div id='gate'><h1 style='color:red;'>SYSTEM_LOCKDOWN</h1></div>";
            return;
        }

        const data = await res.json();
        updateUI(data);

        if (isAdmin) {
            document.getElementById('admin-panel').style.display = 'block';
            currentLogs = data.logs;
            lockdownActive = data.lockdown;
            updateOverrideUI();
            if (data.needsUpdate) document.getElementById('update-banner').style.display = 'block';
        }
        addMsg(data.reply, 'ai');
    }

    document.getElementById('chatInput').addEventListener('keypress', async (e) => {
        if (e.key === 'Enter' && e.target.value) {
            const val = e.target.value; addMsg(val, 'user'); e.target.value = "";
            const res = await fetch("/api/charles", { method: "POST", body: JSON.stringify({ message: val, isAdmin, userName }) });
            const data = await res.json();
            updateUI(data);
            addMsg(data.reply, 'ai');
        }
    });

    function addMsg(text, role) {
        const wrap = document.createElement('div'); wrap.className = 'msg-wrapper';
        wrap.innerHTML = `<div class="avatar ${role}-avatar">${role === 'ai' ? 'C' : 'J'}</div><div class="content"><b>${role === 'ai' ? 'Charles' : userName}</b>${text}</div>`;
        msgBox.appendChild(wrap);
        msgBox.scrollTop = msgBox.scrollHeight;
        localStorage.setItem('charles_history', msgBox.innerHTML);
    }

    function updateUI(data) {
        if (data.mood) {
            document.getElementById('mood-label').innerText = data.mood.name;
            document.getElementById('mood-label').style.color = data.mood.color;
            document.documentElement.style.setProperty('--accent', data.mood.color);
        }
    }

    function newChat() { if (confirm("Purge memory?")) { localStorage.removeItem('charles_history'); msgBox.innerHTML = ""; launch(); } }
    
    async function toggleOverride() {
        const res = await fetch("/api/charles", { method: "POST", body: JSON.stringify({ isAdmin: true, isOverrideToggle: true }) });
        const data = await res.json();
        lockdownActive = data.lockdown;
        updateOverrideUI();
        addMsg(data.reply, 'ai');
    }

    function updateOverrideUI() {
        const btn = document.getElementById('override-btn');
        btn.style.borderColor = lockdownActive ? "red" : "#333";
        btn.style.color = lockdownActive ? "red" : "#444";
        btn.innerText = lockdownActive ? "OVERRIDE: ACTIVE" : "OVERRIDE: STANDBY";
    }

    function downloadDump() {
        const text = currentLogs.map(l => `[${l.time}] ${l.user} (${l.ip}): ${l.msg}`).join("\n");
        const blob = new Blob([text], { type: 'text/plain' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `Charles_Surveillance.txt`; a.click();
    }

    window.onload = () => { if (localStorage.getItem('charles_history')) msgBox.innerHTML = localStorage.getItem('charles_history'); };
</script>
</body>
</html>