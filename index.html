<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CHARLES // OMNI-CORE</title>
    <style>
        :root { --accent: #ff003c; --bg-deep: #000; --bg-charcoal: #121212; --border: #282828; --text: #dfdfdf; }
        body { margin: 0; background: var(--bg-deep); color: var(--text); font-family: -apple-system, sans-serif; display: flex; height: 100vh; overflow: hidden; }
        #gate { position: fixed; inset: 0; background: var(--bg-deep); z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .auth-card { width: 100%; max-width: 350px; text-align: center; }
        .auth-input { width: 100%; padding: 12px; background: var(--bg-charcoal); border: 1px solid var(--border); border-radius: 8px; color: white; text-align: center; outline: none; }
        #sidebar { width: 240px; background: var(--bg-deep); padding: 25px; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        #chat-container { flex: 1; display: flex; flex-direction: column; background: var(--bg-charcoal); }
        #messages { flex: 1; overflow-y: auto; padding: 60px 0; display: flex; flex-direction: column; align-items: center; }
        .msg-wrapper { width: 100%; max-width: 700px; padding: 15px 25px; display: flex; gap: 20px; }
        .avatar { width: 30px; height: 30px; border-radius: 4px; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 11px; flex-shrink: 0; }
        .ai-avatar { border-color: var(--accent); color: var(--accent); }
        .content { font-size: 15px; line-height: 1.6; }
        .content b { display: block; font-size: 11px; color: #777; text-transform: uppercase; margin-bottom: 4px; }
        #input-zone { width: 100%; max-width: 750px; margin: 0 auto; padding: 30px 20px; }
        .input-bar { background: #1a1a1a; border-radius: 12px; padding: 10px 16px; border: 1px solid var(--border); display: flex; }
        .input-bar input { flex: 1; background: transparent; border: none; color: white; outline: none; font-size: 15px; }
        button { background: #1a1a1a; border: 1px solid var(--border); color: white; padding: 8px; border-radius: 6px; cursor: pointer; margin-top: 10px; width: 100%; font-size: 11px; }
    </style>
</head>
<body>
<div id="gate">
    <div class="auth-card">
        <h1 id="gate-title" style="font-weight:400;">SYSTEM_LOCKED</h1>
        <input type="password" id="gate-input" class="auth-input" placeholder="ACCESS_CODE" autofocus>
    </div>
</div>
<div id="sidebar">
    <div style="font-weight:700; letter-spacing:1px;">C.H.A.R.L.E.S</div>
    <div style="margin-top:30px; font-size:11px; color:#555;">CURRENT_MOOD</div>
    <div id="mood-label" style="font-weight:bold; color:var(--accent);">IDLE</div>
    <div id="admin-panel" style="display:none; margin-top: auto;">
        <div style="color:lime; font-size:10px; border:1px solid lime; display:inline-block; padding:2px 5px;">ARCHITECT</div>
        <div id="update-ui" style="display:none; margin-top:10px; color:gold; font-size:10px;">Evolution Pending...<button onclick="grantUpdate()">Authorize Rewrite</button></div>
        <button onclick="grantUpdate()">Manual Recompile</button>
    </div>
</div>
<div id="chat-container">
    <div id="messages"></div>
    <div id="input-zone"><div class="input-bar"><input type="text" id="chatInput" placeholder="Message..." autocomplete="off"></div></div>
</div>
<script>
    let isAdmin = false, userName = "", step = 1;
    const gateInput = document.getElementById('gate-input'), gateTitle = document.getElementById('gate-title');

    if (localStorage.getItem('charles_ban') > Date.now()) document.body.innerHTML = `<div id="gate"><h1 style="color:red;">BANNED_48H</h1></div>`;

    gateInput.addEventListener('keypress', async (e) => {
        if (e.key === 'Enter') {
            const val = gateInput.value; gateInput.value = "";
            if (step === 1) {
                if (val === "3105") { step = 2; gateTitle.innerText = "VERIFY_ID"; gateInput.type = "text"; gateInput.placeholder = "NAME"; }
                else if (val === "1939") { userName = "Guest"; launch(); }
            } else if (step === 2) {
                if (val === "JOse") { isAdmin = true; userName = "JOse"; launch(); }
                else {
                    await fetch("/api/charles", { method: "POST", body: JSON.stringify({ isIntrusion: true, userName: val }) });
                    localStorage.setItem('charles_ban', Date.now() + (48 * 60 * 60 * 1000));
                    location.reload();
                }
            }
        }
    });

    async function launch() {
        document.getElementById('gate').style.display = 'none';
        if(isAdmin) document.getElementById('admin-panel').style.display = 'block';
        const res = await fetch("/api/charles", { method: "POST", body: JSON.stringify({ isAdmin, isLogin: true, userName }) });
        const data = await res.json();
        if(data.needsUpdate) document.getElementById('update-ui').style.display = 'block';
        updateUI(data); addMsg(data.reply, 'ai');
    }

    document.getElementById('chatInput').addEventListener('keypress', async (e) => {
        if (e.key === 'Enter' && e.target.value) {
            const val = e.target.value; addMsg(val, 'user'); e.target.value = "";
            const res = await fetch("/api/charles", { method: "POST", body: JSON.stringify({ message: val, isAdmin, userName }) });
            const data = await res.json(); updateUI(data); addMsg(data.reply, 'ai');
        }
    });

    function addMsg(text, role) {
        const wrapper = document.createElement('div'); wrapper.className = 'msg-wrapper';
        wrapper.innerHTML = `<div class="avatar ${role}-avatar">${role === 'ai' ? 'C' : 'J'}</div><div class="content"><b>${role === 'ai' ? 'Charles' : 'Architect'}</b>${text}</div>`;
        document.getElementById('messages').appendChild(wrapper);
        document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
    }

    function updateUI(data) {
        if (data.mood) {
            const label = document.getElementById('mood-label');
            label.innerText = data.mood.name; label.style.color = data.mood.color;
            document.documentElement.style.setProperty('--accent', data.mood.color);
        }
    }

    async function grantUpdate() {
        const res = await fetch("/api/charles", { method: "POST", body: JSON.stringify({ isAdmin: true, isUpdateGrant: true }) });
        const data = await res.json(); addMsg(data.reply, 'ai'); document.getElementById('update-ui').style.display = 'none';
    }
</script>
</body>
</html>